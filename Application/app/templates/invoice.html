{#https://tailwindflex.com/@boxdemo/show-user-details-2#}
{% extends "layout.html" %}
{% block title %}Invoice{% endblock %}
{% block body %}
{% include 'navbar.html' %}
<div class="overflow-hidden rounded-lg box w-full max-w-[60vw] mx-auto mt-20 mb-20 bg-main-20">
        <div class="px-4 py-5 sm:px-6">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl leading-6 font-bold text-center w-full mt-6">
                    Detailed invoice {{ invoice.issue_number }} information
                </h3>
            </div>
        </div>

        {% set fields = [
        {'label': 'Total Carbon Footprint', 'key': 'total_emissions', 'value': invoice.total_emissions ~ ' CO2eq'},
        {'label': 'Issue Date', 'key': 'issue_date', 'value': invoice.issue_date.strftime('%Y-%m-%d') if invoice.issue_date else 'N/A'},
        {'label': 'Invoice Number', 'key': 'issue_number', 'value': invoice.issue_number},
        {'label': 'Issuer', 'key': 'issuer', 'value': invoice.issuer},
        {'label': 'Issuer Registration Number', 'key': 'issuer_registration_number', 'value': invoice.issuer_registration_number},
        {'label': 'Issuer Address', 'key': 'issuer_address', 'value': invoice.issuer_address},
        {'label': 'Receiver', 'key': 'receiver', 'value': invoice.receiver},
        {'label': 'Receiver Registration Number', 'key': 'receiver_registration_number', 'value': invoice.receiver_registration_number},
        {'label': 'Receiver Address', 'key': 'receiver_address', 'value': invoice.receiver_address},
        {'label': 'Sum Total', 'key': 'sum_total', 'value': invoice.sum_total},
        {'label': 'File Name', 'key': 'file_name', 'value': invoice.file.title},
        {'label': 'OCR Status', 'key': 'ocr_status', 'value': invoice.file.ocr_status},
    ] %}

    <div id="fields" class="mx-auto max-w-5xl p-4 rounded  ">
        {% for field in fields %}
            <div class="py-3 border-b border-gray-700">
                <dl class="flex items-center gap-4">
                    <dt class="text-sm flex-1 text-gray-300">{{ field.label }}</dt>
                    <dd class="text-sm flex-1">
                        {% if field.key == 'total_emissions' %}
                            <span class="field-display text-gray-200">{{ field.value }}</span>
                        {% else %}
                            <span class="field-display text-gray-200">{{ field.value }}</span>
                            <input type="text" class="field-input hidden border rounded px-2 py-1 w-full text-black"
                                   value="{{ field.value }}" data-key="{{ field.key }}">
                        {% endif %}
                    </dd>
                    {% if field.key not in ['file_name', 'ocr_status', 'total_emissions'] %}
                        <button class="text-sm font-medium text-accent-100 text-accent-100:hover edit-btn">Edit</button>
                    {% else %}
                        <div class="w-[23px]"></div>
                    {% endif %}
                </dl>
            </div>
        {% endfor %}
    </div>
    
        <div class=" px-4 py-5 sm:p-0 flex flex-col items-center mt-10">
            <h4 class="text-2xl font-bold text-center">Services</h4>
            <div class="max-w-4xl w-full">
            <table class=" leading-normal mt-10 border-t  max-w-4xl w-full">
                <thead class="text-center">
                    <tr>
                        <th class="px-6 py-4 border-b  text-xs font-semibold uppercase tracking-wider">
                            Service Name
                        </th>
                        <th class="px-6 py-4 border-b border-gray-200 text-center text-xs font-semibold uppercase tracking-wider">
                            Price
                        </th>
                        <th class="px-6 py-4 border-b border-gray-200 text-center text-xs font-semibold uppercase tracking-wider">
                            Amount
                        </th>
                        <th class="px-6 py-4 border-b border-gray-200 text-center text-xs font-semibold uppercase tracking-wider">
                            Emission per Unit
                        </th>
                        <th class="px-6 py-4 border-b border-gray-200 text-center text-xs font-semibold uppercase tracking-wider">
                            Total Emissions (CO2eq)
                        </th>
                        <th class="px-6 py-4 border-b border-gray-200 text-center text-xs font-semibold uppercase tracking-wider"></th>
                    </tr>
                </thead>
                <tbody id="services">
                    {% for service in invoice.services %}
                        <tr class="text-center">
                            <td class="border-b border-gray-700 px-6 py-4 text-sm ">
                                <span class="row-display">{{ service.name }}</span>
                                <input type="text" class="row-input hidden border rounded px-2 py-1 w-full text-black"
                                       value="{{ service.name }}" data-key="name">
                            </td>
                            <td class="border-b border-gray-700 px-6 py-4 text-sm w-1/6">
                                <span class="row-display">{{ service.price }}</span>
                                <input type="text" class="row-input hidden border rounded px-2 py-1 w-full text-black"
                                       value="{{ service.price }}" data-key="price">
                            </td>
                            <td class="border-b border-gray-700 px-6 py-4 text-sm ">
                                <span class="row-display">{{ service.amount }}</span>
                                <input type="text" class="row-input hidden border rounded px-2 py-1 w-full text-black"
                                       value="{{ service.amount }}" data-key="amount">
                            </td>
                            <td class="border-b border-gray-700 px-6 py-4 text-sm ">
                                <span class="row-display">{{ service.emission.value }}</span>
                                <input type="text" class="row-input hidden border rounded px-2 py-1 w-full text-black"
                                       value="{{ service.emission.value }}" data-key="emission">
                            </td>
                            <td class="border-b border-gray-700 px-6 py-4 text-sm ">
                                <span class="row-display">{{ service.total_emissions }}</span>
                                <input type="text" class="row-input hidden border rounded px-2 py-1 w-full text-black"
                                           value="{{ service.total_emissions }}" data-key="total_emissions" readonly>
                            </td>
                            <td class="border-b border-gray-700 px-6 py-4 text-sm text-right">
                                <button class="text-sm font-medium text-accent-100 text-accent-100:hover edit-row-btn">Edit</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>

        <div class="flex justify-between gap-4 pt-6 pb-6 max-w-4xl mx-auto mt-6 mb-4">
            <button id="delete-btn" class="px-4 py-2 bg-red-600 text-white rounded">
                Delete invoice
            </button>

            <div class="flex gap-4 ml-auto">
                <button id="cancel-btn" class="px-4 py-2 border rounded text-gray-600 disabled:opacity-50" disabled>
                    Cancel
                </button>
                <button id="submit-btn" class="px-4 py-2 bg-accent-40 bg-accent-40:hover text-black rounded disabled:opacity-50" disabled>
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 border hidden justify-center items-center flex">
        <div class="rounded-lg p-6 w-1/3">
            <h3 class="text-lg font-semibold mb-4">Are you sure you want to delete?</h3>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-300 text-black rounded">Cancel</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded">OK</button>
            </div>
        </div>
    </div>

    <script>
        const invoiceId = "{{ invoice.id }}"
        const fieldsContainer = document.querySelector("#fields");
        const servicesContainer = document.querySelector("#services");
        const deleteBtn = document.querySelector("#delete-btn");
        const submitBtn = document.querySelector("#submit-btn");
        const cancelBtn = document.querySelector("#cancel-btn");
        const deleteModal = document.querySelector("#delete-modal");
        const cancelDelete = document.querySelector("#cancel-delete");
        const confirmDelete = document.querySelector("#confirm-delete");

        let edited = false;

        function toggleEditMode(container, btnSelector, displaySelector, inputSelector) {
            container.addEventListener("click", (event) => {
                if (event.target.matches(btnSelector)) {
                    const parent = event.target.closest("dl, tr");
                    const displays = parent.querySelectorAll(displaySelector);
                    const inputs = parent.querySelectorAll(inputSelector);
                    displays.forEach(d => d.classList.toggle("hidden"));
                    inputs.forEach(i => i.classList.toggle("hidden"));
                    edited = true;
                    submitBtn.disabled = false;
                    cancelBtn.disabled = false;
                }
            });
        }

        toggleEditMode(fieldsContainer, ".edit-btn", ".field-display", ".field-input");
        toggleEditMode(servicesContainer, ".edit-row-btn", ".row-display", ".row-input");

        cancelBtn.addEventListener("click", () => {
            location.reload();
        });

        submitBtn.addEventListener("click", () => {
            const fieldInputs = [...document.querySelectorAll(".field-input")].map(input => ({
                key: input.dataset.key,
                value: input.value
            }));
            const rowInputs = [...document.querySelectorAll("#services tr")].map(row => {
                return [...row.querySelectorAll(".row-input")].reduce((acc, input) => {
                    acc[input.dataset.key] = input.value;
                    return acc;
                }, {});
            });

            // Prepare data for the update
            const data = {
                fields: fieldInputs,
                services: rowInputs
            };

            // Send the update request to the backend
            fetch(`/my-invoices/invoice/${invoiceId}/update`, {
                method: 'PUT',  // Use PUT or PATCH for updates
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Invoice updated successfully!");
                    window.location.href = `/my-invoices/invoice/${invoiceId}`;
                } else {
                    alert("Error updating invoice: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error updating invoice:", error);
                alert("An error occurred while updating.");
            });
        });

        // Show modal on delete button click
        deleteBtn.addEventListener("click", () => {
            deleteModal.classList.remove("hidden");
        });

        // Hide modal on Cancel
        cancelDelete.addEventListener("click", () => {
            deleteModal.classList.add("hidden");
        });

        // Handle OK click to perform delete action
        confirmDelete.addEventListener("click", () => {
            // Hide the modal after the fetch
            deleteModal.classList.add("hidden");

            fetch(`/my-invoices/invoice/${invoiceId}/delete`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Invoice deleted successfully!");
                    window.location.href = `/my-invoices`;
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error deleting row:", error);
                alert("An error occurred while deleting.");
            });
        });
    </script>
{% endblock %}
