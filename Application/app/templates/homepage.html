{% extends "layout.html" %}
{% block title %}Homepage Page{% endblock %}
{% block body %}

    {% include 'navbar.html' %}
    {% block style %}
        <style>
            #ocrButton {
                display: {% if file_uploaded %} block {% else %} none {% endif %};
                padding: 10px 20px;
                justify-content: center;
                margin-top: 20px;
            }
        </style>
    {% endblock %}

    <div class="flex flex-col items-center justify-start min-h-screen pt-10 relative">


        <h1 class="text-4xl font-bold mb-6 text-white">Upload invoice</h1>

        <div class="text-center flex flex-col items-center mx-4 min-h-6">
            {% with messages = get_flashed_messages(with_categories=True) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="{{ 'text-green-500 font-semibold' if category == 'alert-success' else 'text-red-500 font-bold' }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div class="text-red-500 hidden" id="fileMessage">Only PDF files are allowed</div>
        </div>


        <div class="bg-main-20 p-6 rounded shadow-md w-100 mt-6">
            <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{{ url_for('main.homepage') }}">
                <div
                        id="dropArea"
                        class="border-dashed border-2 border-gray-300 rounded-lg p-4 mb-4 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-500 transition duration-200"
                        onclick="document.getElementById('fileInput').click()"
                >
                    <p class="text-gray-500 dark:text-white">Drag and drop your files here or click to select</p>
                    <input type="file" name="files" id="fileInput" multiple required class="hidden"
                           onchange="showFileNames()" accept="application/pdf">
                </div>

                <ul id="fileNames" class="mb-4 text-gray-100 pl-4"></ul>

                <button type="submit"
                        class="w-full bg-accent-40 text-black py-2 rounded hover:bg-accent hover:text-white transition duration-200">
                    Upload
                </button>

            </form>
            <button type="submit" id="ocrButton"
                    class="w-full bg-accent-40 text-black py-2 rounded hover:bg-accent hover:text-white transition duration-200">
                Convert invoice
            </button>
        </div>


    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const errorMessage = document.getElementById('fileMessage');
        let selectedFiles = [];

        function showFileNames() {
            const fileNamesDisplay = document.getElementById('fileNames');
            const files = fileInput.files;

            fileNamesDisplay.innerHTML = '';

            // Hide the error message
            errorMessage.style.display = 'none';

            // Get the selected files as an array
            selectedFiles = Array.from(files);

            // Display loop for selected files
            if (selectedFiles.length > 0) {
                selectedFiles.forEach((file, index) => {
                    // If the file is not a PDF, display an error message and remove it from the selectedFiles array
                    if (file.type !== 'application/pdf') {
                        errorMessage.style.display = 'block';
                        // Remove the invalid file from the selectedFiles array
                        selectedFiles.splice(index, 1);
                    } else {
                        const li = document.createElement('li');
                        li.classList.add('flex', 'justify-between', 'items-center');

                        const fileName = document.createElement('span');
                        fileName.textContent = file.name;
                        li.appendChild(fileName);

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.className = 'text-red-500 ml-4 hover:underline';
                        deleteButton.onclick = () => {
                            deleteFile(index);
                        };

                        li.appendChild(deleteButton);
                        fileNamesDisplay.appendChild(li);
                    }
                });
            }
        }

        function deleteFile(index) {
            selectedFiles.splice(index, 1);
            updateFileInput();
            showFileNames();
        }

        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => {
                dataTransfer.items.add(file);
            });
            fileInput.files = dataTransfer.files;
        }

        dropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropArea.classList.add('bg-gray-300');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('bg-gray-300');
        });

        dropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            dropArea.classList.remove('bg-gray-300');

            const files = Array.from(event.dataTransfer.files);
            selectedFiles = selectedFiles.concat(files);

            if (files.length > 0) {
                updateFileInput();
                showFileNames();
            }
        });

        fileInput.addEventListener('change', (event) => {
            updateFileInput();
        });
    </script>
{% endblock %}
