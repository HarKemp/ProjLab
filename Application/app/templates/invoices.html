{% extends "layout.html" %}
{% block body %}
{% include 'navbar.html' %}
<h1 class="text-2xl font-semibold mb-4 text-center">Your Invoices</h1>

<div class="max-w-xl mx-auto mt-8">
    <table id="invoices-table" class="border-collapse mx-auto">
        <thead>
            <tr>
                <th class="border-b-2 p-2 text-center">Title</th>
                <th class="border-b-2 p-2 text-center">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for invoice in invoices %}
            <tr id="invoice-{{ invoice.id }}" class="hover:bg-gray-100">
                <td class="border-b p-2 text-center invoice-title">{{ invoice.title }}</td>
                <td class="border-b p-2 text-center invoice-status">
                    {% if invoice.ocr_status == "Pending" %}
                        <span class="text-white font-semibold">Pending</span>
                    {% elif invoice.ocr_status == "Processing" %}
                        <span class="text-white font-semibold">Processing</span>
                    {% elif invoice.ocr_status == "Complete" %}
                        <span class="text-green-500 font-semibold">Complete</span>
                    {% else %}
                        <span class="text-red-500 font-semibold">Error</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
  function updateInvoiceRow(invoice) {
    const row = document.getElementById(`invoice-${invoice.id}`);
    if (!row) return;

    const statusCell = row.querySelector('.invoice-status');
    let statusHtml = '';

    if (invoice.ocr_status === 'Pending') {
      statusHtml = '<span class="text-white font-semibold">Pending</span>';
    } else if (invoice.ocr_status === 'Processing') {
      statusHtml = '<span class="text-white font-semibold">Processing</span>';
    } else if (invoice.ocr_status === 'Complete') {
      statusHtml = '<span class="text-green-500 font-semibold">Complete</span>';
    } else {
      statusHtml = '<span class="text-red-500 font-semibold">Error</span>';
    }
    statusCell.innerHTML = statusHtml;
  }

  function fetchStatusUpdates() {
    fetch("{{ url_for('main.invoice_status') }}")
      .then(response => response.json())
      .then(data => {
        data.forEach(invoice => {
          updateInvoiceRow(invoice);
        });
      })
      .catch(err => console.error('Error fetching invoice status:', err));
  }

  // Send GET request to server every 10 seconds
  setInterval(fetchStatusUpdates, 10000);
</script>
{% endblock %}